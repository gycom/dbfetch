<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Time Entry Sheet</title>
    <style>
        .header {
            margin:0;
            padding:0;
            width:100vw;
            height:120px;
            background-image:url("./BackgroundTile.PNG");
        }
        #usernameslot {font-size:16px}
        input {margin-right:10px;}
        img.imgaction {cursor:pointer;width:24px;}
        li:hover{background-color:#f0f0f0;}
        menu {background-color:white;margin:0;padding:0;}
        menu.li:hover {cursor:pointer}
        #actionbox ul {margin:0;padding:0;cursor:pointer;list-style-type:none;}
        #customerlookup {
            position:absolute;
            width:auto;
            height:auto;
            max-height:80vh;
            overflow-y:scroll;
            top:20px;
            left:100px;
            background-color:white;
            z-index:100;
            margin:0;
            padding:0;
            border:2px solid black;    
        }
        #joblookup {
            position:absolute;
            width:auto;
            height:auto;
            max-height:80vh;
            overflow-y:scroll;
            top:200px;
            left:100px;
            background-color:white;
            z-index:100;
            margin:0;
            padding:0;
            border:2px solid black;    
        }
        #operationlookup {
            position:absolute;
            width:auto;
            height:auto;
            max-height:80vh;
            overflow-y:scroll;
            top:200px;
            left:100px;
            background-color:white;
            z-index:100;
            margin:0;
            padding:0;
            border:2px solid black;    
        }
        
        #actionbox{
            position:absolute;
            width:auto;
            height:auto;
            background-color:white;
            z-index:100;
            margin:0;
            padding:0;
        }
        #shadow {
            top:0;
            left:0;
            position:absolute;
            width:100%;
            height:100%;
            background-color:black;
            opacity:0.1;
            z-index:90;
            margin:0;
            padding:0;
        }
        input{border:1px dotted green;background-color:none;}
        input:selected{border:2px solid black}
        li > .imgaction {visibility:hidden}
        li:hover > .imgaction {visibility:visible}
        ul >li.row {list-style-type:none;}
        li.row {cursor:pointer}
        span.col {width:100px;display:inline-block;}
        #activeuser {}
        .toolbar {float:right;margin-right:50px}
    </style>
    <link rel="stylesheet" href="simplepicker.css" />
    <script>
        window.onload=window.setTimeout(bodyLoad,1000);
        var displaymode = "BASIC";
        var state = {user:undefined};
        var userlist = [];
        var customerjob = [];
        var productoperation = [];
        var root;
        //alert(document.location.host)
        console.log("api url",document.location.host.substr(0,3))
        if (document.location.host.substr(0,3)!="127.")
            root="http://jobtrack.dev.intranet.cyframe.com/CMACEntral/developertools/rssfeed/tools/timesheetroot/";
        else
            root="http://localhost:8100/";

        function bodyLoad()
        {
            document.getElementById("activeuser").innerText="... loading data ...";
            Promise.all(
                [
                    fetch(root + "api.asp?perform=version").then(response=>response.text())
                    , fetch(root + "api.asp?perform=refcustomerjob").then(response=>response.json())
                    , fetch(root + "api.asp?perform=refproductoperation").then(response=>response.json())
                ]
            ).then((rep)=>{
                customerjob = rep[1].map(normalizeCustomer);
                productoperation = rep[2].map(normalizeProduct);
                start(state,rep[0]);
            }).catch(err=>{
                document.getElementById("activeuser").innerHTML = "ERROR: " + err.message;
                console.error(err)
            });
            function normalizeCustomer(e)
            {
                var x = e;
                x.CUSTOMER_ID = x.CUSTOMER_ID.trim();
                x.CUSTOMER_NAME = x.CUSTOMER_NAME.trim();
                x.PRODUCT_ID = x.PRODUCT_ID.trim();
                return x;
            }
            function normalizeProduct(e)
            {
                var x=e;
                x.PRODUCT_ID = x.PRODUCT_ID.trim();
                return x;
            }
        }
        function start(state,version)
        {
            fetch(root+"api.asp?perform=userlist")
                .then(response=>response.json())
                .then(json=>builduserlist(trimname(json)))
        }
        function trimname(json)
        {
            return json.map(trimMe);
            function trimMe(e)
            {
                e.NAME_OF_USER=e.NAME_OF_USER.trim();
                e.USER_ID=e.USER_ID.trim();
                return e;
            }
        }
        function builduserlist(json)
        {
            var username="";
            var cookieuser=window.localStorage.getItem("user");
            var div=document.getElementById("activeuser");
            div.innerHTML = ("<select style='display:none' id='userid' onchange='selectUser()'>"
                                + "<option value=''>--choose user--</option>" 
                                + json.sort(NameAlpha).map(renderuser).join("")
                                + "</select><span id='usernameslot'>&nbsp;"
                                + username 
                                + " (<a href='javascript:void(0)' onclick='unlockUser()'>not you?</a>)</span>");
            selectUser();
            function NameAlpha(a,b)
            {
                var a_name=a.NAME_OF_USER.split(" ")[1];
                var b_name=b.NAME_OF_USER.split(" ")[1];
                return a_name>b_name?1:a_name<b_name?-1:0;
            }
            function renderuser(e)
            {
                var selected="";
                if (e.USER_ID==cookieuser) {selected=" selected "; username=e.NAME_OF_USER;};
                return "<option "+selected+" value='"+e.USER_ID+"'>"+e.NAME_OF_USER+"</option>";
            }
        }
        function unlockUser()
        {
            var opt = document.getElementById("userid");
            opt.style.display="inline";
            var slot = document.getElementById("usernameslot");
            slot.style.display="none";
        }
        function selectUser()
        {
            var user=document.getElementById("userid").value;
            state={user:user};
            window.localStorage.setItem("user",user);
            if (user=="") 
                setuserdata([]);
            else
                fetch(root+"api.asp?perform=getuser&userid="+state.user)
                    .then(response=>response.json())
                    .then(json=>setuserdata(json))
                    .catch(err=>console.log("fetch data error ",err));
        }
        function setuserdata(json)
        {
            if (state.user!="")
            {
                state.data = json;
                displaydata();
                if (json.length==0) ActionNew();
            }
            else
            {
                state.data = [];
                displaydata();
            }

        }
        function displaydata()
        {
            var div=document.getElementById("userdata");
            switch(displaymode)
            {
                case "BASIC": div.innerHTML=BasicDisplay();
                default: displaymode="BASIC";BasicDisplay();
            }
        }
        function BasicDisplay()
        {
            console.log(state.data);
            return basictitle() + state.data.map(basicrow).join("");
            function basicrow(e)
            {
                return ["<li id='"+e.WIP_ID+"' title='"+e.WIP_ID+"' onchange='Change(this)'>"
                    ,boxCustomer(e,"CUSTOMER_ID")
                    ,boxJob(e,"JOB_ID",5)
                    ,boxcalendar(e,"PUNCH_DATE")
                    ,boxOperation(e,"PUNCH_OPERATION",4)
                    ,box(e,"PUNCH_DURATION",4)
                    ,box(e,"TICKET_REF",8)
                    ,boxComment(e,"COMMENT_ID")
                    ,ellipsis(e)
                    ,"</li>"].join("");
            }
            function basictitle()
            {
                return ("<table style='font-weight:bolder;'>"
                    + [20,120,50,60,60,80,100].map(maketitlecol).join("") 
                    + "<tr>" 
                    + [ "","Client"  ,"Job"   ,"Date"   ,"Operation"   ,"Duration"   ,"Ticket Ref"   ,"Comments"].map(maketitleheader).join("")
                    + "</tr>" 
                    + "</table>"
                );
                function maketitlecol(c)
                {
                    return "<col width='"+c+"px'>";
                }
                function maketitleheader(h)
                {
                    return "<td>"+h+"</td>";
                }
            }
            function box(e,key,size)
            {
                var txt=e[key];
                return "<input type='text' name='"+key+"' value='"+(txt||"")+"' size='"+(size||"15")+"' autocomplete='off'>";
            }
            function boxCustomer(e,key,size)
            {
                var txt=e[key];
                return "<input type='text' name='"+key+"' value='"+(txt||"")+"' size='"+(size||"15")+"' ondblclick='PopCustomerLookup(this)' autocomplete='off'>";
            }
            function boxJob(e,key,size)
            {
                var txt=e[key];
                return "<input type='text' name='"+key+"' value='"+(txt||"")+"' size='"+(size||"15")+"' ondblclick='PopJobLookup(this)' autocomplete='off'>";
            }
            function boxOperation(e,key,size)
            {
                var txt=e[key];
                return "<input type='text' name='"+key+"' value='"+(txt||"")+"' size='"+(size||"15")+"' ondblclick='PopOperationLookup(this)' autocomplete='off'>";
            }
            function boxComment(e,key)
            {
                var txt=e[key];
                return ("<input type='hidden' name='"+key+"' value='"+(txt||"")+"'>"
                        +"<img src='ConfirmationMemo.gif' width=20px onclick='PopComment(this)' style='margin-right:30px' />"
                        );
            }
            function boxcalendar(e,key,size)
            {
                var txt=e[key];
                return "<input type='text' name='"+key+"' value='"+(txt||"")+"' size='"+(size||"10")+"' ondblclick='PopCalendar(this)' autocomplete='off'>";
            }
            function ellipsis(e)
            {
                return "<img class='imgaction' src='more.png' align=absmiddle onclick='popAction("+e.WIP_ID+")'/>";
            }
        }
        function popAction(wipid)
        {
            var div = loadingOn("actionbox");
            div.innerHTML = ["<ul class='menu' onclick='DoAction("+wipid+")'>"
                ,["New","Copy","Delete"].map(t=>"<li>"+t+"</li>").join("")
                ,"</ul>"].join("");
            div.style.top = window.event.clientY+"px";
            div.style.left = window.event.clientX+"px";
            document.body.appendChild(div);
        }
        function clearAction()
        {
            loadingOff();
        }
        var shielded=null;
        function loadingOn(toShield)
        {
            shielded=toShield;
            var div=document.createElement("div");
            div.id="shadow"
            div.onclick = loadingOff;
            document.body.appendChild(div);
            var pop = document.createElement("div");
            pop.id=toShield;
            return pop;
        }
        function loadingOff()
        {
            console.log("shield",shielded);
            var pop = document.getElementById(shielded);
            document.body.removeChild(pop);
            var div=document.getElementById("shadow");
            div.onclick = null;
            document.body.removeChild(div);
        }
        function DoAction(wipid)
        {
            console.log("Do action...");
            var ev = window.event;
            var action=ev.srcElement.innerText;
            console.log("Action "+action + " " + wipid)
            switch(action)
            {
                case "New": ActionNew(); break;
                case "Copy": ActionCopy(wipid); break;
                case "Delete": ActionDelete(wipid); break;
            }
            clearAction();
        }
        function ActionNew()
        {
            fetch(root+"api.asp?perform=createnew&userid="+state.user)
                .then(response=>response.json())
                .then(json=>{
                    console.log(json);
                    state.data.push(json[0]);
                    displaydata();
                })
                .catch(err=>console.log(err));
        }
        function ActionCopy(wipid)
        {
            fetch(root+"api.asp?perform=duplicateone&userid="+state.user+"&wipid="+wipid)
                .then(response=>response.json())
                .then(json=>{
                    console.log(json);
                    state.data.push(json[0]);
                    displaydata();
                })
                .catch(err=>console.log(err));
        }
        function ActionDelete(wipid)
        {
            fetch(root+"api.asp?perform=deleteone&userid="+state.user+"&wipid="+wipid)
                .then(response=>response.json())
                .then(json=>{
                    console.log(json);
                    state.data = state.data.filter((d)=>d.WIP_ID!=wipid);
                    displaydata();
                })
                .catch(err=>console.log(err));
        }
        function Change(li,input)
        {
            var wipid = li.id; // find parent <li>
            if (!input)
                var obj = window.event.srcElement;
            else
                var obj = input;
            if (obj.tagName=="INPUT") console.log(obj.name,obj.value);
            var data = "";
/*            input.forEach((n)=>{
                //console.log(n.name, n.value);
                if (n.name==obj.name) data=obj.name+"='"+obj.value+"'";
            })*/
            data = obj.name +"='" + obj.value + "'";
            fetch(root+"api.asp?perform=updateone&userid="+state.user+"&wipid="+wipid+"&data="+decodeURIComponent(data))
                .then(response=>response.json())
                .then(json=>{
                    console.log("changing",json)
                })
                .catch(err=>console.log(err));
//            console.log(obj)
        }
        function PopCalendar(obj)
        {
            var simplepicker = new SimplePicker({zIndex:100});
            simplepicker.open();
            simplepicker.on("close",(date)=>{
                
            });
            simplepicker.on("submit",(date,readableDate)=>{
                obj.value=date.getFullYear()+"-"+pad(date.getMonth()+1)+"-"+pad(date.getDate());
                console.log(obj)
            })
            function pad(n)
            {
                if (n<10) return "0"+n;
                return ""+n;
            }
        }
        function parentLI(obj)
        {
            while (obj.tagName!="LI")
                obj = obj.parentElement;
            return obj;
        }
        function PopCustomerLookup(obj)
        {
            var wipid = parentLI(obj).id; // find parent <li>
            console.log("wipid",wipid);
            var div=loadingOn("customerlookup");
            div.innerHTML = ["<ul class='menu' onclick='CloseCustomerLookup("+wipid+")'>"
                , customerjob.reduce(distinctCustomer,[]).map(renderCustomer).join("")
                ,"</ul>"].join("");
            document.body.appendChild(div);
            function distinctCustomer(t,e)
            {
                if (t.filter((c)=>c.CUSTOMER_ID==e.CUSTOMER_ID).length==0)
                {
                    t.push({CUSTOMER_ID:e.CUSTOMER_ID,CUSTOMER_NAME:e.CUSTOMER_NAME})
                }
                return t;
            }
            function renderCustomer(e)
            {
                return "<li class='row' customer='" + e.CUSTOMER_ID + "'><span class='col'>" + e.CUSTOMER_ID + "</span>" + e.CUSTOMER_NAME+"</li>";
            }
        }
        function CloseCustomerLookup(wipid)
        {
            if (wipid)
            {
                console.log("close",wipid);
                var src = parentLI(window.event.srcElement);
                var customer = src.getAttribute("customer");
                console.log(src)
                var line = document.getElementById(wipid)
                var input = line.querySelector("input");
                input.value=customer;
                Change(line,input);
            }
            loadingOff();
        }
        function PopJobLookup(obj)
        {
            var wipid = parentLI(obj).id; // find parent <li>
            var currentcustomer = document.getElementById(wipid).querySelector("input[name='CUSTOMER_ID']").value.trim();
            var joblist = customerjob.filter(filterCurrentCustomer);
            console.log(joblist);
            var div=loadingOn("joblookup");
            div.innerHTML = ["<ul class='menu' onclick='CloseJobLookup("+wipid+")'>"
                , joblist.map(renderJob).join("")
                ,"</ul>"].join("");
            document.body.appendChild(div);
            function filterCurrentCustomer(e)
            {
                var test = e.CUSTOMER_ID==currentcustomer || currentcustomer=="";
                //console.log(currentcustomer,"+"+e.CUSTOMER_ID+"+",test)
                return test;
            }
            function renderJob(e)
            {
                var proddesc = productoperation.filter(o=>o.PRODUCT_ID==e.PRODUCT_ID)[0].PRODUCT_DESC;
                return "<li class='row' JOB_ID='" + e.JOB_HEADERS_NUM + "'>" + e.JOB_HEADERS_NUM + " - " + proddesc + "</li>";
            }
        }
        function CloseJobLookup(wipid)
        {
            if (wipid)
            {
                var src = window.event.srcElement;
                var jobid = src.getAttribute("JOB_ID");
                var line = document.getElementById(wipid)
                var input = line.querySelector("input[name='JOB_ID']");
                input.value=jobid;
                Change(line,input);
            }
            loadingOff();
        }
        function PopOperationLookup(obj)
        {
            var wipid = parentLI(obj).id; // find parent <li>
            var currentjob = document.getElementById(wipid).querySelector("input[name='JOB_ID']").value.trim();
            var operationlist = customerjob.filter(filterCurrentJob);
            console.log(operationlist);
            var div=loadingOn("operationlookup");
            div.innerHTML = ["<ul class='menu' onclick='CloseOperationLookup("+wipid+")'>"
                , operationlist.map(renderOperation).join("")
                ,"</ul>"].join("");
            document.body.appendChild(div);
            function filterCurrentJob(e)
            {
                var test = e.JOB_HEADERS_NUM==currentjob || currentjob=="";
                return test;
            }
            function renderOperation(e)
            {
                console.log(e)
                var opdesc = productoperation.filter(o=>o.PRODUCT_ID==e.PRODUCT_ID)[0].OP_DESC;
                return "<li class='row' OPERATION_ID='" + e.OPERATION_ID + "'>" + e.OPERATION_ID + " - " + opdesc + "</li>";
            }
        }
        function CloseOperationLookup(wipid)
        {
            if (wipid)
            {
                var src = window.event.srcElement;
                var operationid = src.getAttribute("OPERATION_ID");
                console.log(src)
                var line = document.getElementById(wipid)
                var input = line.querySelector("input[name='OPERATION_ID']");
                input.value=operationid;
                Change(line,input);
            }
            loadingOff();
        }
        function validateall()
        {
            alert("todo...");
        }
        function convertpunch()
        {
            alert("todo...");
        }
        function PopComment(obj)
        {
            alert("todo...")
        }
    </script>
</head>
<body>
    <h1 class="header"><img src="./Cyframe.gif" width=64 height64 align="absmiddle">Quick Time Entry Sheet
        <span class="toolbar">
            <button onclick="validateall()">Validate</button>
            <button onclick="convertpunch()">Convert to Punch</button>
        </span>
        <div id="activeuser"></div>
    </h1>
    <div id="userdata"></div>
    <script src="./simplepicker.js"></script>
    <script>
    </script>
</body>
</html>
