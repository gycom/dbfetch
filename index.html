<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Time Entry Sheet</title>
    <style>
        .header {
            margin:0;
            padding:0;
            width:100vw;
            height:120px;
            background-image:url("./BackgroundTile.PNG");
        }
        #usernameslot {font-size:16px}
        input {margin-right:10px;}
        img.imgaction {cursor:pointer;width:24px;}
        span.imgactionfiller{display:inline-block;width:24px}
        li:hover{background-color:#f0f0f0;}
        menu {background-color:white;margin:0;padding:0;}
        menu.li:hover {cursor:pointer}
        .userdatalist{list-style-type:none;margin:0;padding:0;}
        #actionbox ul {margin:0;padding:0;cursor:pointer;list-style-type:none;}
        #customerlookup {
            position:absolute;
            width:auto;
            height:auto;
            max-height:80vh;
            overflow-y:scroll;
            top:20px;
            left:100px;
            background-color:white;
            z-index:100;
            margin:0;
            padding:0;
            border:2px solid black;    
        }
        #ticketlookup {
            position:absolute;
            width:auto;
            height:auto;
            max-height:80vh;
            overflow-y:scroll;
            top:20px;
            left:100px;
            background-color:white;
            z-index:100;
            margin:0;
            padding:0;
            border:2px solid black;    
        }
        #joblookup {
            position:absolute;
            width:auto;
            height:auto;
            max-height:80vh;
            overflow-y:scroll;
            top:200px;
            left:100px;
            background-color:white;
            z-index:100;
            margin:0;
            padding:0;
            border:2px solid black;    
        }
        #operationlookup {
            position:absolute;
            width:auto;
            height:auto;
            max-height:80vh;
            overflow-y:scroll;
            top:200px;
            left:100px;
            background-color:white;
            z-index:100;
            margin:0;
            padding:0;
            border:2px solid black;    
        }
        #commenteditor {
            position:absolute;
            width:500px;
            height:50vh;
            overflow-y:scroll;
            top:200px;
            left:100px;
            background-color:white;
            z-index:100;
            margin:0;
            padding:20px;
            border:2px solid black;
        }
        #actionbox{
            position:absolute;
            width:auto;
            height:auto;
            background-color:white;
            z-index:100;
            margin:0;
            padding:0;
        }
        #shadow {
            top:0;
            left:0;
            position:absolute;
            width:100%;
            height:100%;
            background-color:black;
            opacity:0.1;
            z-index:90;
            margin:0;
            padding:0;
        }
        input{border:1px dotted green;background-color:none;}
        input:selected{border:2px solid black}
        li > .imgaction {visibility:hidden}
        li:hover > .imgaction {visibility:visible}
        ul >li.row {list-style-type:none;}
        li.row {cursor:pointer}
        span.col {width:100px;display:inline-block;}
        #activeuser {display:block;}
        .toolbar {float:right;margin-right:50px}
        .JiraText {width:100px;overflow-x:hidden;text-overflow:ellipsis;}

        .col-check{width:10px;display:inline-block;margin-right:15px;}
        .col-0 {width:30px;display:inline-block;margin-right:10px;}
        .col-1 {width:100px;display:inline-block;margin-right:10px;}
        .col-2 {width:100px;display:inline-block;margin-right:10px;}
        .col-3 {width:160px;display:inline-block;margin-right:10px;}
        .col-4 {width:100px;display:inline-block;margin-right:10px;}
        .col-5 {width:100px;display:inline-block;margin-right:10px;}
        .col-6 {width:130px;display:inline-block;margin-right:10px;}
        .col-7 {width:50px;display:inline-block;margin-right:10px;}
        .col-8 {width:100px;display:inline-block;margin-right:10px;}
        .bigbutton {
            width:150px;
            height:70px;
            background-image:url(./MenuOFF.gif);
            font-size:24px;
            text-align:center;
            padding-top:15px;
            margin-top:3px;
            cursor:pointer;
        }
        span.plusmoins {
            display:inline-block;
            width:20px;
            background-color:lightgreen;
            text-align:center;
            margin-right:5px;
            cursor:pointer;
        }
    </style>
    <link rel="stylesheet" href="simplepicker.css" />
    <script>
        window.onload=window.setTimeout(bodyLoad,1000);
        var displaymode = "BASIC";
        var state = {user:undefined};
        var userlist = [];
        var customerjob = [];
        var productoperation = [];
        var ticketlist = [];
        var root;
        var csroot;
        //alert(document.location.host)
        console.log("api url",document.location.host.substr(0,3))
        var fake=false;
        if (!fake)
        {    
            root="http://jobtrack.dev.intranet.cyframe.com/CMACEntral/developertools/rssfeed/tools/timesheetroot/";
            csroot="http://jtcyframe.prod.intranet.cyframe.com/punch/ReviewTimeSheet/";
        }
        else
        {    
            root="http://localhost:8100/";
            csroot=root;
        }

        function bodyLoad()
        {
            document.getElementById("activeuser").innerText="... loading data ...";
            Promise.all(
                [
                    fetch(root + "api.asp?perform=version").then(response=>response.text())
                    , fetch(root + "api.asp?perform=refcustomerjob").then(response=>response.json())
                    , fetch(root + "api.asp?perform=refproductoperation").then(response=>response.json())
                    , fetch(csroot+"actJiraList.asp",
                    {
                        method:"POST",
                        headers:{
                            "content-type":"application/x-www-form-urlencoded"
                        },
                        body: "ACTION=ListTask"
                    }).then(response=>response.json())
                ]
            ).then((rep)=>{
                customerjob = rep[1].map(normalizeCustomer);
                productoperation = rep[2].map(normalizeProduct);
                ticketlist = JSON.parse(rep[3].result).issues;
                //console.log("ticketlist",ticketlist);
                start(state,rep[0]);
            }).catch(err=>{
                document.getElementById("activeuser").innerHTML = "ERROR: " + err.message;
                console.error(err)
            });
            function normalizeCustomer(e)
            {
                var x = e;
                x.CUSTOMER_ID = x.CUSTOMER_ID.trim();
                x.CUSTOMER_NAME = x.CUSTOMER_NAME.trim();
                x.PRODUCT_ID = x.PRODUCT_ID.trim();
                return x;
            }
            function normalizeProduct(e)
            {
                var x=e;
                x.PRODUCT_ID = x.PRODUCT_ID.trim();
                return x;
            }
        }
        function start(state,version)
        {
            fetch(root+"api.asp?perform=userlist")
                .then(response=>response.json())
                .then(json=>builduserlist(trimname(json)))
        }
        function trimname(json)
        {
            return json.map(trimMe);
            function trimMe(e)
            {
                e.NAME_OF_USER=e.NAME_OF_USER.trim();
                e.USER_ID=e.USER_ID.trim();
                return e;
            }
        }
        function builduserlist(json)
        {
            var username="";
            var cookieuser=window.localStorage.getItem("user");
            var div=document.getElementById("activeuser");
            div.innerHTML = ("<select style='display:none' id='userid' onchange='selectUser()'>"
                                + "<option value=''>--choose user--</option>" 
                                + json.sort(NameAlpha).map(renderuser).join("")
                                + "</select><span id='usernameslot'>&nbsp;"
                                + username 
                                + " (<a href='javascript:void(0)' onclick='unlockUser()'>not you?</a>)</span>");
            selectUser();
            function NameAlpha(a,b)
            {
                var a_name=a.NAME_OF_USER.split(" ")[1];
                var b_name=b.NAME_OF_USER.split(" ")[1];
                return a_name>b_name?1:a_name<b_name?-1:0;
            }
            function renderuser(e)
            {
                var selected="";
                if (e.USER_ID==cookieuser) {selected=" selected "; username=e.NAME_OF_USER;};
                return "<option "+selected+" value='"+e.USER_ID+"'>"+e.NAME_OF_USER+"</option>";
            }
        }
        function unlockUser()
        {
            var opt = document.getElementById("userid");
            opt.style.display="inline";
            var slot = document.getElementById("usernameslot");
            slot.style.display="none";
        }
        function selectUser()
        {
            var user=document.getElementById("userid").value;
            state={user:user};
            window.localStorage.setItem("user",user);
            if (user=="") 
                setuserdata([]);
            else
            {
                Promise.all(
                    [
                        fetch(root+"api.asp?perform=getuser&userid="+state.user).then(response=>response.json())
                        ,fetch(root+"api.asp?perform=getcommentlist&userid="+state.user).then(response=>response.json())
                    ]
                ).then(result=>{
                    setuserdata(result[0],result[1]);
                }).catch(err=>console.log("fetch data error ",err));
            }
        }
        function setuserdata(json,comment)
        {
            if (state.user!="")
            {
                state.data = json;
                if (comment)
                    state.comment = comment;
                displaydata();
                if (json.length==0) ActionNew();
            }
            else
            {
                state.data = [];
                displaydata();
            }

        }
        function displaydata()
        {
            var div=document.getElementById("userdata");
            div.innerHTML = "";
            switch(displaymode)
            {
                case "BASIC": div.innerHTML=BasicDisplay();
                default: displaymode="BASIC";BasicDisplay();
            }
        }
        function BasicDisplay()
        {
            console.log(state.data);
            return basictitle() + state.data.map(basicrow).join("");
            function basicrow(e)
            {
                return ["<li id='"+e.WIP_ID+"' title='"+e.WIP_ID+"' onchange='Change(this)' class='userdatalist'>"
                    ,ellipsis(e)
                    ,"<span class='col-check'>"+checkbox(e,"CHECKED_YN")+"</span>"
                    ,"<span class='col-1'>"+boxCustomer(e,"CUSTOMER_ID",12)+"</span>"
                    ,"<span class='col-2'>"+boxJob(e,"JOB_ID",5)+"</span>"
                    ,"<span class='col-3'>"+boxcalendar(e,"PUNCH_DATE",10)+"</span>"
                    ,"<span class='col-4'>"+boxOperation(e,"PUNCH_OPERATION",4)+"</span>"
                    ,"<span class='col-5'>"+box(e,"PUNCH_DURATION",4)+"</span>"
                    ,"<span class='col-6'>"+boxJira(e,"TICKET_REF",8)+"</span>"
                    ,"<span class='col-7'>"+boxComment(e,"COMMENT_ID")+"</span>"
                    ,jiradesc(e)
                    ,"</li>"].join("");
            }
            function basictitle()
            {
                return ("<table style='font-weight:bolder;'>"
                    + "<tr>" 
                    + [ checkAllBox()
                        ,"Client"  
                        ,"Job"   
                        ,"Date"   
                        ,"Operation"   
                        ,"Duration"   
                        ,"Ticket Ref"
                        ,"Comments"   ].map(maketitleheader).join("")
                    + "</tr>" 
                    + "</table>"
                );
                function maketitlecol(c)
                {
                    return "<col width='"+c+"px'>";
                }
                function maketitleheader(h,n)
                {
                    return "<td class='col-"+n+"'>"+h+"</td>";
                }
            }
            function checkAllBox()
            {
                return "<nobr><span class='imgactionfiller'></span><input type='checkbox' name='CHECK_ALL' onclick='checkAll()'></nobr>";
            }
            function box(e,key,size)
            {
                var txt=e[key];
                return "<input type='text' name='"+key+"' value='"+(txt||"")+"' size='"+(size||"15")+"' autocomplete='off'>";
            }
            function boxCustomer(e,key,size)
            {
                var txt=e[key];
                return "<input type='text' name='"+key+"' maxlength=12 value='"+(txt||"")+"' size='"+(size||"15")+"' ondblclick='PopCustomerLookup(this)' autocomplete='off'>";
            }
            function boxJob(e,key,size)
            {
                var txt=e[key];
                return "<input type='text' name='"+key+"' maxlength=11 value='"+(txt||"")+"' size='"+(size||"15")+"' ondblclick='PopJobLookup(this)' autocomplete='off'>";
            }
            function boxOperation(e,key,size)
            {
                var txt=e[key];
                return "<input type='text' name='"+key+"' maxlength=3 value='"+(txt||"")+"' size='"+(size||"15")+"' ondblclick='PopOperationLookup(this)' autocomplete='off'>";
            }
            function boxComment(e,key)
            {
                var txt=e[key];
                return ("<input type='hidden' name='"+key+"' value='"+(txt||"")+"'>"
                        +"<img src='ConfirmationMemo.gif' width=16px align=absmiddle onclick='PopComment(this)' style='margin-right:30px;"+(!txt?"opacity:.5":"")+"' />"
                        );
            }
            function checkbox(e,key)
            {
                var txt=e[key]||"";
                return (
                    "<input type='checkbox' name='" + key + "' " + (txt=="Y"?"checked":"") + " onclick='Activate(parentLI(this))' value='Y'>"
                );
            }
            function boxcalendar(e,key,size)
            {
                var txt=(e[key]||"").substr(0,10);
                return ("<span class='plusmoins' onclick='plusmoins(this)'>-</span>"
                        +"<input type='text' name='"+key+"' maxlength=10 value='"+(txt||"")+"' size='"+(size||"10")+"'  ondblclick='PopCalendar(this)' autocomplete='off'>"
                        +"<span class='plusmoins' onclick='plusmoins(this)'>+</span>"
                        );
            }
            function boxJira(e,key,size)
            {
                var txt=e[key]||"";
                if (txt.substr(0,3).toUpperCase()=="CS-") txt=txt.substr(3);
                return (
                    "CS-<input type='text' name='"+key+"' maxlength=4 value='"+(txt||"")+"' size='"+(size||"10")+"' "
                    +" onchange='LoadJira(this)' ondblclick='PopTicketLookup(this)' autocomplete='off'>"
                );
            }
            function jiradesc(e)
            {
                var txt = e["COMMENT_ID"];
                if (txt!=undefined)
                {
                    var comment = state.comment.filter(c=>c.COMMENT_ID==txt)[0]||{SHORT_TEXT:""}; 
                    txt = comment.SHORT_TEXT;
                }
                else
                {
                    txt = "";
                }
                return (
                    "<span class='JiraText'>" + txt + "</span>"
                );

            }
            function ellipsis(e)
            {
                return "<img class='imgaction' src='more.png' align=absmiddle onclick='popAction("+e.WIP_ID+")'/>";
            }
        }
        Date.prototype.addDays = function(days) {
            var date = new Date(this.valueOf());
            date.setDate(date.getDate() + days);
            return date;
        }
        function plusmoins(obj)
        {
            var dir = obj.innerText;
            var line = parentLI(obj);
            var wipid = line.id;
            var datebox = line.querySelector("input[name='PUNCH_DATE']");
            if (datebox.value!="")
                var d = new Date(datebox.value);
            else
                var d = new Date();
            d = d.addDays(dir=="-"?-1:1);
            
            datebox.value = d.toJSON().substr(0,10);
            Change(line,datebox);
        }
        function popAction(wipid)
        {
            var div = loadingOn("actionbox");
            div.innerHTML = ["<ul class='menu' onclick='DoAction("+wipid+")'>"
                ,["New","Copy","Delete"].map(t=>"<li>"+t+"</li>").join("")
                ,"</ul>"].join("");
            div.style.top = window.event.clientY+"px";
            div.style.left = window.event.clientX+"px";
            document.body.appendChild(div);
        }
        function clearAction()
        {
            loadingOff();
        }
        var shielded=null;
        function loadingOn(toShield)
        {
            shielded=toShield;
            var div=document.createElement("div");
            div.id="shadow"
            div.onclick = loadingOff;
            document.body.appendChild(div);
            var pop = document.createElement("div");
            pop.id=toShield;
            return pop;
        }
        function loadingOff()
        {
            console.log("shield",shielded);
            var pop = document.getElementById(shielded);
            document.body.removeChild(pop);
            var div=document.getElementById("shadow");
            div.onclick = null;
            document.body.removeChild(div);
        }
        function DoAction(wipid)
        {
            console.log("Do action...");
            var ev = window.event;
            var action=ev.srcElement.innerText;
            console.log("Action "+action + " " + wipid)
            switch(action)
            {
                case "New": ActionNew(); break;
                case "Copy": ActionCopy(wipid); break;
                case "Delete": ActionDelete(wipid); break;
            }
            clearAction();
        }
        function ActionNew()
        {
            fetch(root+"api.asp?perform=createnew&userid="+state.user)
                .then(response=>response.json())
                .then(json=>{
                    console.log(json);
                    state.data.push(json[0]);
                    displaydata();
                })
                .catch(err=>console.log(err));
        }
        function ActionCopy(wipid)
        {
            fetch(root+"api.asp?perform=duplicateone&userid="+state.user+"&wipid="+wipid)
                .then(response=>response.json())
                .then(json=>{
                    console.log(json);
                    state.data.push(json[0]);
                    displaydata();
                })
                .catch(err=>console.log(err));
        }
        function ActionDelete(wipid)
        {
            fetch(root+"api.asp?perform=deleteone&userid="+state.user+"&wipid="+wipid)
                .then(response=>response.json())
                .then(json=>{
                    console.log(json);
                    state.data = state.data.filter((d)=>d.WIP_ID!=wipid);
                    displaydata();
                })
                .catch(err=>console.log(err));
        }
        function Activate(li,input)
        {
            var wipid = li.id;
        }
        function Change(li,input)
        {
            var wipid = li.id; // find parent <li>
            if (!input)
                var obj = window.event.srcElement;
            else
                var obj = input;
            if (obj.tagName=="INPUT") console.log(obj.name,obj.value);
            var data = "";
            if (obj.type=="checkbox")
            {
                data = obj.name +"='" + (obj.checked?"Y":"N") + "'";
            }
            else
            {
                switch(obj.name)
                {
                    case "PUNCH_DATE": 
                        data = obj.name + "=TO_DATE('"+obj.value+"','YYYY-MM-DD')"; 
                        break;
                    default:
                        data = obj.name + "='" + obj.value + "'";
                        break;
                }
            }
            fetch(root+"api.asp?perform=updateone&userid="+state.user+"&wipid="+wipid+"&data="+decodeURIComponent(data))
                .then(response=>response.json())
                .then(json=>{
                    console.log("changing",json)
                })
                .catch(err=>console.log(err));
//            console.log(obj)
        }
        function PopCalendar(obj)
        {
            var date=new Date();
            obj.value=date.getFullYear()+"-"+pad(date.getMonth()+1)+"-"+pad(date.getDate());
            Change(parentLI(obj),obj);
            return;
            var simplepicker = new SimplePicker({zIndex:100});
            simplepicker.open();
            simplepicker.on("close",(date)=>{
                
            });
            simplepicker.on("submit",(date,readableDate)=>{
                obj.value=date.getFullYear()+"-"+pad(date.getMonth()+1)+"-"+pad(date.getDate());
                console.log(obj)
            })
            function pad(n)
            {
                if (n<10) return "0"+n;
                return ""+n;
            }
        }
        function parentLI(obj)
        {
            while (obj.tagName!="LI")
                obj = obj.parentElement;
            return obj;
        }
        function PopTicketLookup(obj)
        {
            var wipid = parentLI(obj).id; // find parent <li>
            console.log("wipid",wipid);
            var div=loadingOn("ticketlookup");
            div.innerHTML = ["<ul class='menu' onclick='CloseTicketLookup("+wipid+")'>"
                , ticketlist.map(renderTicket).join("")
                ,"</ul>"].join("");
            document.body.appendChild(div);
            /*function distinctCustomer(t,e)
            {
                if (t.filter((c)=>c.CUSTOMER_ID==e.CUSTOMER_ID).length==0)
                {
                    t.push({CUSTOMER_ID:e.CUSTOMER_ID,CUSTOMER_NAME:e.CUSTOMER_NAME})
                }
                return t;
            }*/
            function renderTicket(e)
            {
                return ("<li class='row' ticket='" + e.key + "'>"
                        + "<span class='col'>" 
                        + e.key 
                        + "</span>" 
                        + e.fields.summary 
                        + "</li>"
                );
            }
        }
        function CloseTicketLookup(wipid)
        {
            if (wipid)
            {
                console.log("close",wipid);
                var src = parentLI(window.event.srcElement);
                var ticket = src.getAttribute("ticket");
                console.log(src)
                var line = document.getElementById(wipid)
                var input = line.querySelector("input[name='TICKET_REF']");
                input.value = ticket.substr(3);
                Change(line,input);
                input.onchange()
            }
            loadingOff();
        }

        function PopCustomerLookup(obj)
        {
            var wipid = parentLI(obj).id; // find parent <li>
            console.log("wipid",wipid);
            var div=loadingOn("customerlookup");
            div.innerHTML = ["<ul class='menu' onclick='CloseCustomerLookup("+wipid+")'>"
                , customerjob.reduce(distinctCustomer,[]).map(renderCustomer).join("")
                ,"</ul>"].join("");
            document.body.appendChild(div);
            function distinctCustomer(t,e)
            {
                if (t.filter((c)=>c.CUSTOMER_ID==e.CUSTOMER_ID).length==0)
                {
                    t.push({CUSTOMER_ID:e.CUSTOMER_ID,CUSTOMER_NAME:e.CUSTOMER_NAME})
                }
                return t;
            }
            function renderCustomer(e)
            {
                return "<li class='row' customer='" + e.CUSTOMER_ID + "'><span class='col'>" + e.CUSTOMER_ID + "</span>" + e.CUSTOMER_NAME+"</li>";
            }
        }
        function CloseCustomerLookup(wipid)
        {
            if (wipid)
            {
                console.log("close",wipid);
                var src = parentLI(window.event.srcElement);
                var customer = src.getAttribute("customer");
                console.log(src)
                var line = document.getElementById(wipid)
                var input = line.querySelector("input[name='CUSTOMER_ID']");
                input.value=customer;
                Change(line,input);
            }
            loadingOff();
        }
        function PopJobLookup(obj)
        {
            var wipid = parentLI(obj).id; // find parent <li>
            var currentcustomer = document.getElementById(wipid).querySelector("input[name='CUSTOMER_ID']").value.trim();
            var joblist = customerjob.filter(filterCurrentCustomer);
            console.log(joblist);
            var div=loadingOn("joblookup");
            div.innerHTML = ["<ul class='menu' onclick='CloseJobLookup("+wipid+")'>"
                , joblist.map(renderJob).join("")
                ,"</ul>"].join("");
            document.body.appendChild(div);
            function filterCurrentCustomer(e)
            {
                var test = e.CUSTOMER_ID==currentcustomer || currentcustomer=="";
                //console.log(currentcustomer,"+"+e.CUSTOMER_ID+"+",test)
                return test;
            }
            function renderJob(e)
            {
                var proddesc = productoperation.filter(o=>o.PRODUCT_ID==e.PRODUCT_ID)[0].PRODUCT_DESC;
                return "<li class='row' JOB_ID='" + e.JOB_HEADERS_NUM + "'>" + e.JOB_HEADERS_NUM + " - " + proddesc + "</li>";
            }
        }
        function CloseJobLookup(wipid)
        {
            if (wipid)
            {
                var src = window.event.srcElement;
                var jobid = src.getAttribute("JOB_ID");
                var line = document.getElementById(wipid)
                var input = line.querySelector("input[name='JOB_ID']");
                input.value=jobid;
                Change(line,input);
            }
            loadingOff();
        }
        function PopOperationLookup(obj)
        {
            var wipid = parentLI(obj).id; // find parent <li>
            var currentjob = document.getElementById(wipid).querySelector("input[name='JOB_ID']").value.trim();
            var currentproduct = customerjob.filter(filterCurrentJob)[0].PRODUCT_ID;
            var operationlist = productoperation
            console.log(currentproduct);
            var div=loadingOn("operationlookup");
            div.innerHTML = ["<ul class='menu' onclick='CloseOperationLookup("+wipid+")'>"
                , operationlist.filter((p)=>p.PRODUCT_ID==currentproduct).map(renderOperation).join("")
                ,"</ul>"].join("");
            document.body.appendChild(div);
            function filterCurrentJob(e)
            {
                var test = e.JOB_HEADERS_NUM==currentjob || currentjob=="";
                return test;
            }
            function renderOperation(e)
            {
                console.log(e)
                var opdesc = e.OP_DESC;
                return "<li class='row' OPERATION_ID='" + e.OPERATION_ID + "'>" + e.OPERATION_ID + " - " + opdesc + "</li>";
            }
        }
        function CloseOperationLookup(wipid)
        {
            if (wipid)
            {
                var src = window.event.srcElement;
                var operationid = src.getAttribute("OPERATION_ID");
                console.log(src)
                var line = document.getElementById(wipid)
                var input = line.querySelector("input[name='PUNCH_OPERATION']");
                input.value=operationid;
                Change(line,input);
            }
            loadingOff();
        }
        function validateall()
        {
            var div = document.getElementById("debug");
            div.innerHTML = JSON.stringify(ticketlist,null,2);
        }
        function convertpunch()
        {
            fetch(root+"api.asp?perform=convertPunch&userid="+state.user)
                .then(response=>response.json())
                .then(json=>refreshdata(json))
                .catch(err=>console.log(err));
            function refreshdata(json)
            {
                setuserdata(json);
            }
        }
        function PopComment(obj)
        {
            
            var line = parentLI(obj);
            var wipid = line.id;
            var comment = line.querySelector("input[name='COMMENT_ID'");
            if (comment.value!="")
            {
                console.log(comment)
                var buffer = state.comment.filter(c=>c.COMMENT_ID==comment.value);
                console.log(buffer)
                var shorttext = buffer[0].SHORT_TEXT||"";
                var longtext = buffer[0].LONG_TEXT||"";
            }
            else
            {
                var shorttext = "...";
                var longtext = "...";
            }
            var div = loadingOn("commenteditor");
            div.innerHTML = [
                "<input type=text id='SHORT_TEXT' maxlength=50 size=50 value='"+shorttext+"'><br>"
                ,"<textarea cols='50em' rows=10 id='LONG_TEXT'>"+longtext+"</textarea><br>"
                ,"<button onclick=\"saveComment("+wipid+",'"+comment.value+"')\">Save</button>"
                ,"<button onclick='CloseComment()'>Cancel</button>"
                ].join("");
            document.body.appendChild(div);
        }
        function CloseComment()
        {
            loadingOff();
        }
        function saveComment(wipid,commentid)
        {
            var line=document.getElementById(wipid);
            console.log("saving",wipid,commentid);
            if (commentid!="")
            {
                var buffer = state.comment.filter(c=>c.COMMENT_ID==commentid);
                buffer[0].SHORT_TEXT = document.getElementById("SHORT_TEXT").value;
                buffer[0].LONG_TEXT =  document.getElementById("LONG_TEXT").value;
                fetch(root+"api.asp?perform=updatecomment&id="+commentid+"&short="+encodeURIComponent(buffer[0].SHORT_TEXT)+"&long="+buffer[0].LONG_TEXT)
                    .then(response=>response.json())
                    .then(json=>CloseComment())
                    .catch(err=>console.log(err));
            }
            else
            {
                var buffer = [{
                    SHORT_TEXT:document.getElementById("SHORT_TEXT").value,
                    LONG_TEXT:document.getElementById("LONG_TEXT").value
                }];
                fetch(root+"api.asp?perform=createcomment&userid="+state.user+"&wipd="+wipid+"&short="+encodeURIComponent(buffer[0].SHORT_TEXT)+"&long="+buffer[0].LONG_TEXT)
                    .then(response=>response.json())
                    .then(json=>linkcomment(json))
                    .catch(err=>console.log(err));
                function linkcomment(json)
                {
                    console.log(json);
                    buffer.COMMENT_ID = json[0].COMMENT_ID;
                    state.comment.push(buffer);

                    var input = line.querySelector("input[name='COMMENT_ID']");
                    input.value = json[0].COMMENT_ID;
                    commentid = input.value;
                    Change(line,input);
                    CloseComment();
                }
            }
            line.querySelector("span.JiraText").innerText = buffer[0].SHORT_TEXT;
        }
        function LoadJira(obj)
        {//Access-Control-Allow-Origin
        //ACTION=pickOneTaskDet&ROW_DATA=%257B%2522JiraTaskNum%2522%253A%25224484%2522%257D"
            console.log("fetch jira",obj.value);
            var ROW_DATA = {
                "JiraTaskNum": obj.value
            };
            fetch(csroot+"actJiraSync.asp",
                    {
                        method:"POST",
                        headers:{
                            "content-type":"application/x-www-form-urlencoded"
                        },
                        body: "ACTION=pickOneTaskDet&ROW_DATA="+escape(JSON.stringify(ROW_DATA))
                    }
                )
                .then(response=>response.json())
                .then(json=>setJiraText(json))
                .catch(err=>console.log(err));
            function setJiraText(json)
            {
                console.log("setJiraText",json);
                var line = parentLI(obj);
                var sText = "";
                if (json.RequestStatus==200)
                {
                    sText = unescape(json.jrSummary);
                    comment = line.querySelector("input[name='COMMENT_ID']");
                    console.log(comment)
                    var compositeText = json.jrTaskKey + " " + sText;
                    if (comment.value!="")
                    {
                        UpdateShortComment(line.id,comment.value,compositeText);
                    }
                    else
                    {
                        CreateShortComment(line.id,comment.value,compositeText);
                        console.log("creating new comment");
                    }
                }
                else
                {
                    sText = "";
                    compositeText = sText;
                }
                line.querySelector(".JiraText").innerText = compositeText;
            }
        }
        function UpdateShortComment(wipid,commentid,text)
        {
            fetch(root+"api.asp?perform=short&id="+commentid+"&text="+encodeURIComponent(text))
                .then(response=>response.json())
                .then(json=>updateComment(wipid,commentid,json[0].SHORT_TEXT))
                .catch(err=>console.log(err));
            function updateComment(wipid,commentid,text)
            {
                state.comment.filter(c=>c.COMMENT_ID==commentid)[0].SHORT_TEXT= text;
            }
        }
        function CreateShortComment(wipid,commentid,text)
        {
            fetch(root+"api.asp?perform=newshort&userid="+state.user+"&wipid="+wipid+"&text="+encodeURIComponent(text))
                .then(response=>response.json())
                .then(json=>appendComment(json[0]))
                .catch(err=>console.log(err));
            function appendComment(newcomment)
            {
                state.comment.push(newcomment);
            }
        }
    </script>
</head>
<body>
    <h1 class="header"><img src="./Cyframe.gif" width=64 height64 align="absmiddle">Quick Time Entry Sheet
        <span class="toolbar">
            <div onclick="convertpunch()" class="bigbutton">Convert to Punch</div>
        </span>
        <div id="activeuser"></div>
    </h1>
    <div id="userdata"></div>
    <pre id="debug"></pre>
    <script src="./simplepicker.js"></script>
    <script>
    </script>
</body>
</html>
